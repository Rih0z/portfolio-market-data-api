# Portfolio Market Data API 技術仕様書

## 目次

1. [概要](#1-概要)
2. [システムアーキテクチャ](#2-システムアーキテクチャ)
3. [コンポーネントと機能モジュール](#3-コンポーネントと機能モジュール)
4. [データフロー](#4-データフロー)
5. [外部サービス連携](#5-外部サービス連携)
6. [マーケットデータ取得](#6-マーケットデータ取得)
7. [エラーハンドリングとフォールバック](#7-エラーハンドリングとフォールバック)
8. [キャッシュ戦略](#8-キャッシュ戦略)
9. [監視とアラート](#9-監視とアラート)
10. [セキュリティ実装](#10-セキュリティ実装)
11. [運用管理機能](#11-運用管理機能)

## 1. 概要

Portfolio Market Data APIは、投資ポートフォリオ管理アプリケーション向けの金融市場データ提供サービスです。米国株式、日本株式、投資信託、為替レートなどのデータを複数のソースから取得し、統一されたインターフェースを通じて提供します。

### 1.1 主要機能

- 複数のデータソースからの金融市場データ取得
- データの検証とクレンジング
- 強力なフォールバックメカニズム
- キャッシュによるパフォーマンス最適化
- Google OAuth認証とGoogle Drive連携
- 使用量制限と予算管理
- 管理者向け監視・管理ツール

### 1.2 技術スタック

- **プラットフォーム**: AWS Lambda (サーバーレス)
- **データストア**: Amazon DynamoDB
- **通知サービス**: Amazon SNS
- **予算管理**: Amazon Budgets
- **認証**: Google OAuth 2.0
- **外部連携**: Google Drive API
- **通信**: RESTful API (JSON)
- **ランタイム**: Node.js

## 2. システムアーキテクチャ

### 2.1 全体構成

```
                  ┌───────────┐
                  │  API      │
                  │  Gateway  │
                  └─────┬─────┘
                        │
                        ▼
┌─────────────────────────────────────────┐
│            Lambda Functions             │
├─────────────┬───────────┬───────────────┤
│ Market Data │   Auth    │  Drive I/F    │
│   Module    │  Module   │   Module      │
└──────┬──────┴─────┬─────┴───────┬───────┘
       │            │             │
       ▼            ▼             ▼
┌──────────┐  ┌───────────┐ ┌────────────┐
│ External │  │ DynamoDB  │ │  Google    │
│  APIs    │  │ (Cache/   │ │  Drive API │
│          │  │  Session) │ │            │
└──────────┘  └───────────┘ └────────────┘
```

### 2.2 コンポーネント間の関係

- **API Gateway**: リクエストの受付、ルーティング、認証ヘッダーの検証
- **Lambda Functions**: ビジネスロジックとデータ処理
- **DynamoDB**: キャッシュデータとセッション情報の保存
- **External APIs**: 金融市場データの取得源
- **Google APIs**: 認証とGoogleドライブ連携

### 2.3 デプロイ環境

システムは複数の環境にデプロイ可能:

- **開発環境** (dev): 開発者向けテスト環境
- **テスト環境** (test): 自動テスト用環境
- **本番環境** (prod): エンドユーザー向け環境

環境固有の設定は環境変数を通じて管理され、`envConfig.js`でロードされる。

## 3. コンポーネントと機能モジュール

### 3.1 設定モジュール

- **constants.js**: システム全体で使用される定数定義
  - データタイプ
  - キャッシュ時間
  - データソース優先順位
  - エラーコード
- **envConfig.js**: 環境変数の管理と型変換

### 3.2 マーケットデータモジュール

- **marketData.js**: メインAPI関数
- **sources/**: 各データソースの実装
  - **yahooFinance.js**: Yahoo Finance API
  - **marketDataProviders.js**: スクレイピングベースのプロバイダー
  - **fundDataService.js**: 投資信託データ取得
  - **exchangeRate.js**: 為替レート取得
  - **enhancedMarketDataService.js**: フォールバック対応の統合サービス

### 3.3 認証モジュール

- **auth/**: Google認証関連Lambda関数
  - **googleLogin.js**: Google認証コードの処理
  - **getSession.js**: セッション検証
  - **logout.js**: ログアウト処理
- **googleAuthService.js**: Google認証サービス

### 3.4 Google Drive連携モジュール

- **drive/**: Google Drive連携Lambda関数
  - **saveFile.js**: ファイル保存
  - **loadFile.js**: ファイル読み込み
  - **listFiles.js**: ファイル一覧取得

### 3.5 インフラサービス

- **cache.js**: キャッシュ管理
- **usage.js**: API使用量追跡
- **alerts.js**: アラート通知
- **fallbackDataStore.js**: フォールバックデータ管理
- **matrics.js**: データソース性能測定

### 3.6 ユーティリティ

- **awsConfig.js**: AWS SDKの設定
- **budgetCheck.js**: AWS予算チェック
- **dataFetchWithFallback.js**: フォールバック機能付きデータ取得
- **dataValidation.js**: データ検証
- **retry.js**: 再試行ロジック
- **scrapingBlacklist.js**: 失敗した銘柄の管理
- **responseUtils.js**: レスポンス形式の標準化

### 3.7 管理者向けAPI

- **admin/**: 管理者向けLambda関数
  - **getStatus.js**: システム状態取得
  - **getBudgetStatus.js**: 予算状況取得
  - **resetUsage.js**: 使用量リセット
  - **manageFallbacks.js**: フォールバックデータ管理

## 4. データフロー

### 4.1 マーケットデータリクエスト

1. クライアントからのリクエスト（シンボル、データタイプを指定）
2. DynamoDBキャッシュの検索
3. キャッシュヒットした場合はキャッシュデータを返却
4. キャッシュミスした場合:
   1. 優先順位の高いデータソースからデータ取得を試行
   2. データ検証
   3. DynamoDBへのキャッシュ保存
   4. クライアントへのレスポンス返却
5. すべてのデータソースが失敗した場合:
   1. フォールバックデータの検索
   2. クライアントへのフォールバックデータ返却

### 4.2 認証フロー

1. Google OAuth認証:
   1. フロントエンドでGoogleログインを実行
   2. GoogleからのAuthorizationコードをバックエンドに送信
   3. バックエンドでコードを交換してアクセストークンを取得
   4. ユーザー情報を取得してセッションを作成
   5. セッションIDをHTTP Cookieに保存

2. セッション検証:
   1. クライアントからのリクエストにCookieが含まれる
   2. セッションIDをDynamoDBで検索
   3. セッションの有効性を確認
   4. 有効期限の確認

### 4.3 Google Drive連携

1. ファイル保存:
   1. ポートフォリオデータをリクエストで受信
   2. セッションからアクセストークンを取得
   3. Google Drive APIを使用してフォルダ作成またはアクセス
   4. JSONファイルとしてデータを保存
   5. ファイルメタデータをレスポンスとして返却

2. ファイル一覧取得:
   1. セッションからアクセストークンを取得
   2. Google Drive APIで指定フォルダ内のファイル一覧を取得
   3. ファイルメタデータをレスポンスとして返却

3. ファイル読み込み:
   1. ファイルIDをリクエストで受信
   2. セッションからアクセストークンを取得
   3. Google Drive APIでファイルコンテンツを取得
   4. JSONデータをパースしてレスポンスとして返却

## 5. 外部サービス連携

### 5.1 金融データソース

#### 5.1.1 米国株式データソース（優先順位順）

1. **Yahoo Finance API** (RapidAPI): 高速でリアルタイムのデータ
2. **Yahoo Finance Web** (スクレイピング): 基本的な株価データ
3. **MarketWatch** (スクレイピング): 追加のフォールバックオプション

#### 5.1.2 日本株式データソース（優先順位順）

1. **Yahoo Finance Japan** (スクレイピング): 日本株の主要ソース
2. **Minkabu** (スクレイピング): 代替データソース
3. **Kabutan** (スクレイピング): 追加のフォールバックオプション

#### 5.1.3 投資信託データソース

1. **MorningStar CSV**: CSV形式のデータダウンロード
2. フォールバックデータ

#### 5.1.4 為替レートデータソース（優先順位順）

1. **exchangerate-host API**: リアルタイム為替レート
2. **動的計算**: 内部アルゴリズムによる推定レート
3. **ハードコード値**: 緊急時のフォールバック

### 5.2 Google APIs

#### 5.2.1 Google OAuth 2.0

使用スコープ:
- `email`: ユーザーのメールアドレス取得
- `profile`: ユーザーのプロフィール情報取得
- `https://www.googleapis.com/auth/drive.file`: アプリで作成したファイルのみアクセス

#### 5.2.2 Google Drive API

- ファイル作成・読み込み
- フォルダ管理
- メタデータ取得

### 5.3 AWS サービス

- **DynamoDB**: キャッシュ、セッション、使用量データの保存
- **SNS**: 管理者へのアラート通知
- **Budget**: AWS予算監視とコスト制御
- **Lambda**: すべてのビジネスロジックの実行
- **API Gateway**: API管理とアクセス制御

## 6. マーケットデータ取得

### 6.1 データタイプ

| データタイプ | 説明 | キャッシュ時間 | バッチサイズ |
|------------|------|--------------|------------|
| `us-stock` | 米国株式 | 3600秒 (1時間) | 20 |
| `jp-stock` | 日本株式 | 3600秒 (1時間) | 10 |
| `mutual-fund` | 投資信託 | 10800秒 (3時間) | 10 |
| `exchange-rate` | 為替レート | 21600秒 (6時間) | 1 |

### 6.2 データ取得API

```
GET /market-data
```

#### リクエストパラメータ

| パラメータ | 必須 | 説明 |
|-----------|-----|------|
| `type` | ○ | データタイプ (`us-stock`, `jp-stock`, `mutual-fund`, `exchange-rate`) |
| `symbols` | ○ | 銘柄コード（複数はカンマ区切り。例: `AAPL,MSFT,GOOGL`） |
| `refresh` | × | `true`の場合、キャッシュを無視して新しいデータを取得 |
| `base` | △ | 為替レートのベース通貨（`type=exchange-rate`の場合のみ必須） |
| `target` | △ | 為替レートの対象通貨（`type=exchange-rate`の場合のみ必須） |

#### レスポンス例（米国株）

```json
{
  "success": true,
  "data": {
    "AAPL": {
      "ticker": "AAPL",
      "price": 178.45,
      "change": 2.34,
      "changePercent": 1.33,
      "name": "Apple Inc.",
      "currency": "USD",
      "lastUpdated": "2025-05-13T12:34:56Z",
      "source": "Yahoo Finance API",
      "isStock": true,
      "isMutualFund": false
    },
    "MSFT": {
      "ticker": "MSFT",
      "price": 415.23,
      "change": -1.45,
      "changePercent": -0.35,
      "name": "Microsoft Corporation",
      "currency": "USD",
      "lastUpdated": "2025-05-13T12:34:56Z", 
      "source": "Yahoo Finance API",
      "isStock": true,
      "isMutualFund": false
    }
  },
  "lastUpdated": "2025-05-13T12:35:00Z",
  "processingTime": "123ms",
  "usage": {
    "daily": {
      "count": 152,
      "limit": 5000,
      "percentage": 3
    },
    "monthly": {
      "count": 1254,
      "limit": 100000,
      "percentage": 1
    }
  }
}
```

### 6.3 データの検証と異常検出

システムはデータの検証を行い、以下の異常を検出します：

1. **価格変動閾値**: 前回値からの価格変動が20%を超える場合に異常フラグを立てる
2. **ソース間差異**: 複数ソースから取得したデータの差が10%を超える場合に異常フラグを立てる
3. **空データ**: 主要フィールドが空の場合に異常とみなす

異常検出時のアクション：
- 警告レベルに応じたアラート発信
- フォールバックデータの使用
- 異常データのログ記録

## 7. エラーハンドリングとフォールバック

### 7.1 エラーコード

| エラーコード | HTTPステータス | 説明 |
|------------|--------------|------|
| `INVALID_PARAMS` | 400 | パラメータが無効 |
| `LIMIT_EXCEEDED` | 429 | 使用量制限を超過 |
| `SOURCE_ERROR` | 502 | データソースエラー |
| `NOT_FOUND` | 404 | リソースが見つからない |
| `SERVER_ERROR` | 500 | サーバー内部エラー |
| `AUTH_ERROR` | 401 | 認証エラー |
| `NO_SESSION` | 401 | セッションなし |
| `DRIVE_ERROR` | 500 | Google Driveエラー |
| `DATA_SOURCE_ERROR` | 502 | データソース接続エラー |
| `BLACKLISTED` | 403 | ブラックリスト登録済みリソース |
| `DATA_VALIDATION_ERROR` | 400 | データ検証エラー |

### 7.2 フォールバックメカニズム

システムは複数レベルのフォールバックを実装しています：

1. **データソースレベル**: 複数のデータソースを順次試行
2. **キャッシュレベル**: データ取得失敗時にキャッシュデータを利用
3. **フォールバックデータレベル**: GitHubリポジトリから取得した固定データ
4. **デフォルト値レベル**: すべての方法が失敗した場合の最終手段

### 7.3 再試行メカニズム

`retry.js`モジュールによる指数バックオフ再試行：

- 最大再試行回数のカスタマイズ
- 基本遅延時間と最大遅延時間の設定
- 再試行判定関数によるエラータイプに基づく再試行判断

### 7.4 スクレイピングブラックリスト

失敗回数の多い銘柄を一時的にブラックリスト化：

- デフォルトで3回連続失敗でブラックリスト登録
- デフォルトで7日間のクールダウン期間
- ブラックリスト中の銘柄はスクレイピングをスキップしフォールバックデータを使用

## 8. キャッシュ戦略

### 8.1 キャッシュ実装

- **ストレージ**: Amazon DynamoDB
- **キー構造**: `${dataType}:${symbol}`
- **TTL**: データタイプごとに異なる有効期限（constants.jsで定義）

### 8.2 動的キャッシュ時間

ボラティリティに基づく動的キャッシュ時間の調整：

- **高ボラティリティ**: 標準時間の50%
- **中ボラティリティ**: 標準時間の100%
- **低ボラティリティ**: 標準時間の200%

### 8.3 キャッシュ予熱

`preWarmCache.js`によるキャッシュの事前準備：

- 人気銘柄（`PREWARM_SYMBOLS`で定義）のデータを定期的に取得
- 期限切れデータの自動クリーンアップ
- スクレイピングブラックリストの自動クリーンアップ

### 8.4 差分キャッシュ

最新データを効率的に保存する差分キャッシュ機能：

- ベースデータと差分データを分けて保存
- 取得時に動的に合成
- ストレージ使用量の最適化

## 9. 監視とアラート

### 9.1 アラートシステム

`alerts.js`による管理者通知システム：

- Amazon SNSを使用したメール通知
- 重要度に基づくアラートレベル分け
- スロットリング機能によるアラート洪水の防止

### 9.2 予算モニタリング

`budgetCheck.js`によるAWS予算監視：

- 無料枠使用率のリアルタイム監視
- 閾値（50%, 80%, 90%, 95%, 99%）に達した際のアラート
- 予算使用率に基づく機能制限（オプション）

### 9.3 データソースメトリクス

`matrics.js`によるデータソース性能測定：

- 成功率の追跡
- 応答時間の測定
- エラータイプの分析
- 優先順位の動的調整

### 9.4 API使用量

`usage.js`によるAPI使用量の監視：

- 日次・月次の使用量追跡
- ユーザー/IPアドレス別の使用量
- データタイプ別の使用量
- 制限超過時のアクション設定

## 10. セキュリティ実装

### 10.1 認証と認可

- **Google OAuth 2.0**: ユーザー認証
- **セッション管理**: DynamoDBによるセキュアなセッション保存
- **HttpOnly Cookie**: クライアント側JavaScriptからのアクセス防止
- **API Key認証**: 管理者APIへのアクセス制限

### 10.2 データ保護

- **HTTPS**: すべての通信の暗号化
- **Secure Cookie**: HTTPS接続のみでCookieを送信
- **SameSite=Strict**: CSRF攻撃の防止

### 10.3 スクレイピング対策

- **ランダムなUser-Agent**: ブロッキング回避
- **レート制限尊守**: 各ソースごとの適切な遅延設定
- **バックオフ戦略**: 失敗時の指数バックオフ
- **ブラックリスト**: 一時的なスクレイピング停止

### 10.4 予算保護

- **使用量制限**: APIアクセス回数の制限
- **予算閾値**: AWS予算使用率に基づく制限
- **アラート**: 予算使用率のリアルタイム通知

## 11. 運用管理機能

### 11.1 管理者API

- **getStatus.js**: システム状態取得
  - キャッシュ統計
  - API使用統計
  - 設定情報

- **getBudgetStatus.js**: AWS予算情報
  - 現在の使用率
  - 予測使用率
  - 警告レベル

- **resetUsage.js**: API使用量リセット
  - 日次カウンター
  - 月次カウンター
  - 全カウンター

- **manageFallbacks.js**: フォールバックデータ管理
  - フォールバックデータ取得
  - GitHub連携
  - 失敗銘柄統計

### 11.2 ログ管理

`logger.js`によるログレベル設定:

- DEBUG: 開発環境のみ
- INFO: 通常の操作ログ
- WARN: 潜在的な問題
- ERROR: エラー情報
- CRITICAL: 重大なシステムエラー

### 11.3 デプロイと環境設定

`envConfig.js`による環境別設定:

- 開発環境 (development)
- テスト環境 (test)
- 本番環境 (production)

環境変数による設定:
- エンドポイント設定
- キャッシュ時間
- レート制限設定
- 通知設定
- API制限

---

このドキュメントは、Portfolio Market Data APIの技術仕様の概要を説明しています。詳細な実装や最新の変更については、ソースコードのコメントを参照してください。
