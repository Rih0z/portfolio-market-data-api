# ポートフォリオ マーケットデータ API

Node.js、AWS Lambda、API Gateway、DynamoDBを使用して構築された、株式（米国および日本市場）、投資信託、為替レートなどの金融市場データを取得するための堅牢で効率的なAPIです。

## プロジェクト概要

ポートフォリオ マーケットデータ APIは、様々な信頼できるソースからリアルタイムおよびキャッシュされた金融データを提供します。パフォーマンス、コスト効率、および回復力を最適化しながら、信頼性の高い市場データを提供するように設計されています。

## テスト合格数
325

## 特徴

- **マルチソースデータ取得**: 公式APIからデータを取得し、自動フェイルオーバーメカニズムを実装
- **インテリジェントキャッシング**: APIコールを削減し、応答時間を改善
- **Googleによる認証**: Google OAuth経由のセキュアなユーザー認証
- **Google Drive連携**: ポートフォリオデータをGoogle Driveに保存・読み込み
- **適応型レート制限**: API過剰使用を防止し、外部APIの制限を尊重
- **予算監視**: AWS無料枠内に収まるよう使用状況を追跡
- **フォールバックデータストア**: 外部ソースが利用できない場合でもデータ提供
- **包括的なエラー処理**: 情報豊富なエラーメッセージによる適切な機能低下
- **対応市場データ**:
  - 米国株
  - 日本株
  - 投資信託
  - 為替レート

## プロジェクト構成

```
src/
├── config/             # 設定ファイルと定数
├── function/           # Lambda関数ハンドラー
│   ├── admin/          # 管理者向けAPIエンドポイント
│   ├── auth/           # 認証関連のエンドポイント
│   ├── drive/          # Google Drive連携エンドポイント
├── services/           # ビジネスロジックとデータソース
│   ├── sources/        # 各種データソース実装
├── utils/              # ユーティリティ関数
```

## API機能

### マーケットデータ

- **GET /api/market-data**: 株式、投資信託、為替レートデータを取得
  - クエリパラメータ: `type`, `symbols`, `base`(為替), `target`(為替), `refresh`(キャッシュ更新)
- **POST /api/market-data/combined**: 複数種類のデータを一度に取得

### 認証

- **POST /api/auth/google-login**: Googleを使用して認証
- **GET /api/auth/session**: 現在のセッション情報を取得
- **POST /api/auth/logout**: ログアウト処理

### Google Drive

- **GET /api/drive/list-files**: Google Driveのポートフォリオファイル一覧を取得
- **GET /api/drive/load-file**: Google Driveからポートフォリオデータを読み込み
- **POST /api/drive/save-file**: Google Driveにポートフォリオデータを保存

### 管理者用エンドポイント

- **GET /api/admin/status**: API使用状況とキャッシュ情報を取得
- **GET /api/admin/budget-status**: AWS予算の使用状況を取得
- **POST /api/admin/reset-usage**: 使用量カウンターをリセット
- **GET /api/admin/fallbacks**: フォールバックデータを管理

## データソース

- **Yahoo Finance API**: 米国株データの主要ソース
- **Exchange Rate API**: 為替レートデータ
- **その他公式API**: 投資信託データなど

## キャッシュシステム

- DynamoDBを使用したキャッシュレイヤー
- データタイプごとにカスタマイズ可能なTTL(Time To Live)
- 定期的なキャッシュの予熱機能

## 予算管理と使用量制限

- AWS無料枠の使用状況監視
- 予算上限に近づくと警告を表示
- 上限に達した場合のキャッシュ更新制限機能

## エラーハンドリング

- 標準化されたエラーレスポンス形式
- 詳細なエラーコードとメッセージ
- フォールバックデータによる耐障害性

## 認証システム

- Google OAuthを使用した認証
- JWT(セッションID)ベースのセッション管理
- DynamoDBによるセッション保存

## ロギングとアラート

- 構造化ログ出力
- エラーレベルに応じたアラート通知
- 管理者向け重要イベント通知

## 開発ガイドライン

- 環境変数による設定管理
- テスト時のモックレスポンス対応
- 再試行ロジックによる耐障害
