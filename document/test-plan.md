# Portfolio Market Data API - 現実を反映した修正テスト計画

このドキュメントは、Portfolio Market Data APIの現在の実装状況と実際のテスト結果を反映して、より現実的なテスト戦略へと修正したものです。

## 目次

1. [テスト目標](#1-テスト目標)
2. [テストカバレッジの現状と目標](#2-テストカバレッジの現状と目標)
3. [テスト対象コンポーネント](#3-テスト対象コンポーネント)
4. [単体テスト計画](#4-単体テスト計画)
5. [統合テスト計画](#5-統合テスト計画)
6. [エンドツーエンドテスト計画](#6-エンドツーエンドテスト計画)
7. [性能テスト](#7-性能テスト)
8. [セキュリティテスト](#8-セキュリティテスト)
9. [テストデータ管理](#9-テストデータ管理)
10. [継続的インテグレーション](#10-継続的インテグレーション)
11. [テストレポート](#11-テストレポート)

## 1. テスト目標

- **機能検証**: すべてのAPIエンドポイントが期待通りに動作することを確認
- **エラー処理**: すべてのエッジケースで適切なエラーレスポンスを検証
- **性能検証**: レスポンス時間が要件を満たすことを確認（優先度中）
- **セキュリティ評価**: 認証・認可メカニズムの検証（優先度中）
- **コード品質**: 段階的にテストカバレッジを向上させる
- **リグレッション防止**: 新しい変更が既存機能を破壊しないことを確認

## 2. テストカバレッジの現状と目標

| ステージ | 単体テスト | 統合テスト | E2Eテスト |
|---------|------------|-------------|-----------|
| **現在の状況** | **30.7%** | **部分的実装** | **主要パスのみ** |
| 短期目標（3ヶ月） | 45% | 40% | 主要フロー |
| 中期目標（6ヶ月） | 60% | 50% | 重要シナリオ |
| 長期目標（12ヶ月） | 75% | 60% | 包括的 |

*カバレッジの詳細（現状）:*
- ステートメント: 30.7% (970/3160)
- ブランチ: 26.9% (443/1644)
- 関数: 32.6% (111/341)
- ライン: 30.5% (936/3064)

## 3. テスト対象コンポーネント

### 実装済みテストのあるコンポーネント（優先度低）

- **認証サービス**
  - Google OAuth統合
  - セッション管理
  - トークンリフレッシュ

- **Google Drive統合**
  - ファイル操作
  - ポートフォリオデータ管理
  - ファイルリスト取得

- **マーケットデータ取得（部分的）**
  - 米国株データ
  - 日本株データ
  - 為替レートデータ

- **エラー処理（基本的な部分）**
  - エラーレスポンスフォーマット

### テスト強化が必要なコンポーネント（優先度高）

- **マーケットデータ取得の拡張**
  - 投資信託データのテスト強化
  - フォールバックメカニズムの徹底的なテスト

- **キャッシュシステム**
  - キャッシュ取得
  - キャッシュ無効化
  - TTL（生存時間）処理

- **管理者機能**
  - 予算モニタリング
  - 使用統計
  - フォールバックデータ管理

- **エラー処理の拡張**
  - フォールバックデータ戦略
  - リトライメカニズム

## 4. 単体テスト計画

### データソースサービス（現在の進捗: 部分的実装）

| コンポーネント | テストケース | 優先度 | 状況 |
|---------------|-------------|---------|------|
| `enhancedMarketDataService.js` | - 米国株データ取得テスト<br>- 日本株データ取得テスト<br>- 複数銘柄取得テスト<br>- キャッシュ統合テスト<br>- エラーフォールバックテスト | 高 | 基本テスト実装済み、拡張が必要 |
| `yahooFinance.js` | - 株式データフォーマットテスト<br>- APIエラー処理テスト<br>- バッチデータ取得テスト | 中 | 実装済み |
| `exchangeRate.js` | - 通貨ペア処理テスト<br>- フォールバックレートテスト<br>- 様々な通貨組み合わせテスト | 中 | 実装済み |
| `fundDataService.js` | - CSV解析テスト<br>- エラー処理テスト<br>- 複数ファンド取得テスト | 高 | 基本テスト実装済み、拡張が必要 |

### 認証サービス（現在の進捗: 良好）

| コンポーネント | テストケース | 優先度 | 状況 |
|---------------|-------------|---------|------|
| `googleAuthService.js` | - セッション作成テスト<br>- セッション検証テスト<br>- セッション無効化テスト<br>- トークンリフレッシュテスト | 低 | 実装済み |
| `tokenManager.js` | - トークン検証テスト<br>- トークンリフレッシュテスト<br>- IDトークン検証テスト | 低 | 実装済み |

### ユーティリティ関数（現在の進捗: 部分的実装）

| コンポーネント | テストケース | 優先度 | 状況 |
|---------------|-------------|---------|------|
| `responseUtils.js` | - 成功レスポンスフォーマットテスト<br>- エラーレスポンスフォーマットテスト<br>- ヘッダーあり/なしテスト<br>- CORS処理テスト | 低 | 実装済み |
| `cookieParser.js` | - Cookie解析テスト<br>- セッションCookie作成テスト<br>- 複雑なCookieシナリオテスト | 低 | 実装済み |
| `retry.js` | - リトライロジックテスト<br>- 指数バックオフテスト<br>- 最大リトライテスト | 高 | 未実装 |
| `dataFetchWithFallback.js` | - データ取得成功テスト<br>- フォールバック動作テスト<br>- 複数フォールバックテスト | 高 | 部分的に実装、拡張が必要 |
| `scrapingBlacklist.js` | - ブラックリスト追加テスト<br>- ブラックリスト検証テスト<br>- クールダウン期間テスト | 中 | 未実装 |
| `budgetCheck.js` | - 予算警告テスト<br>- 予算クリティカルテスト<br>- メッセージ生成テスト | 中 | 未実装 |

## 5. 統合テスト計画

### データパイプライン統合（現在の進捗: 部分的実装）

| テストシナリオ | 説明 | 優先度 | 状況 |
|---------------|------|---------|------|
| マーケットデータ完全パイプライン | リクエスト → データソース → キャッシュ → レスポンスの完全なフローをテスト | 高 | 基本的なフロー実装済み |
| マルチソースフォールバック | プライマリソースが失敗した場合の複数データソース間のフォールバックをテスト | 高 | 未実装 |
| キャッシュヒット/ミス動作 | キャッシュデータと強制リフレッシュの動作をテスト | 高 | 部分的に実装 |
| バッチデータ取得 | 複数銘柄の一括取得をテスト | 中 | 基本テスト実装済み |

### 認証フロー統合（現在の進捗: 良好）

| テストシナリオ | 説明 | 優先度 | 状況 |
|---------------|------|---------|------|
| 完全認証フロー | ログイン → セッション作成 → トークン検証 → リフレッシュ → ログアウトをテスト | 低 | 実装済み |
| トークン期限切れ | トークンが期限切れになりリフレッシュが必要な場合の動作をテスト | 中 | 実装済み |
| 無効な認証情報 | 無効なトークンと認証情報での動作をテスト | 中 | 実装済み |

### Google Drive統合（現在の進捗: 良好）

| テストシナリオ | 説明 | 優先度 | 状況 |
|---------------|------|---------|------|
| ポートフォリオ保存/読み込み | ポートフォリオデータの保存と読み込みをテスト | 低 | 実装済み |
| ファイルバージョン管理 | バージョン履歴管理をテスト | 低 | 実装済み |
| 複数ユーザーアクセス | 異なるユーザーコンテキストでのテスト | 高 | 未実装 |

### エラー処理統合（現在の進捗: 部分的実装）

| テストシナリオ | 説明 | 優先度 | 状況 |
|---------------|------|---------|------|
| カスケードフォールバック | 複数レベルのフォールバック（API → スクレイピング → キャッシュ → デフォルト）をテスト | 高 | 部分的に実装 |
| レート制限処理 | レート制限に達した場合の動作をテスト | 高 | 未実装 |
| 予算制限適用 | 予算警告と制限適用をテスト | 高 | 未実装 |

## 6. エンドツーエンドテスト計画

### 重要APIフロー（現在の進捗: 基本実装）

| APIフロー | テスト範囲 | 優先度 | 状況 |
|----------|-----------|---------|------|
| 株式データ取得 | API Gateway → Lambda → レスポンスの完全なパスをテスト | 中 | 実装済み |
| ポートフォリオ管理 | 作成 → 読み込み → 更新 → 削除サイクルをテスト | 中 | 実装済み |
| 認証フロー | ユーザー認証ライフサイクル全体をテスト | 中 | 実装済み |

### エラーシナリオ（現在の進捗: 良好）

| シナリオ | テスト範囲 | 優先度 | 状況 |
|----------|-----------|---------|------|
| サービス利用不可 | 外部サービスがダウンしている場合の動作をテスト | 高 | 部分的に実装 |
| 無効な入力 | 不正な形式/無効な入力時のAPI動作をテスト | 低 | 実装済み |
| 認証失敗 | 無効/期限切れの認証での動作をテスト | 低 | 実装済み |

### 複雑なデータシナリオ（現在の進捗: 開始）

| モックモード | テスト範囲 | 優先度 | 状況 |
|-------------|-----------|---------|------|
| 大量データ取得 | 多数の株式/為替データの一度の取得をテスト | 中 | 実装済み |
| 混合データソース | 複数のデータソースからのデータ統合をテスト | 高 | 未実装 |
| キャッシュ動作 | キャッシュヒット/ミスのシナリオをE2Eでテスト | 高 | 未実装 |

## 7. 性能テスト

| テストタイプ | 説明 | メトリクス | 状況 |
|-------------|------|-----------|------|
| レスポンス時間 | 様々なエンドポイントのレスポンス時間測定 | 平均 < 300ms, p95 < 800ms | 未実装 |
| スループット | リクエスト/秒の処理能力テスト | > 100 req/sec | 未実装 |
| 同時実行性 | 同時リクエスト処理のテスト | 20+の同時ユーザーをサポート | 未実装 |
| キャッシュ性能 | キャッシュヒット率の影響測定 | > 80%のレスポンス時間改善 | 未実装 |

## 8. セキュリティテスト

| テストタイプ | 説明 | 優先度 | 状況 |
|-------------|------|---------|------|
| 認証 | 認証バイパス脆弱性のテスト | 高 | 未実装 |
| API入力検証 | インジェクション脆弱性のテスト | 高 | 未実装 |
| トークン管理 | 安全なトークン処理の検証 | 中 | 部分的に実装（単体テスト内） |
| レート制限 | レート制限の有効性テスト | 高 | 未実装 |

## 9. テストデータ管理

現状: 基本的なモックデータのみ実装

### 拡張すべきテストデータセット

- **マーケットデータテストセット**: 一貫したテスト用の標準銘柄（拡張が必要）
- **ユーザー認証テストセット**: 様々な権限レベルを持つテストユーザー（未実装）
- **ポートフォリオテストセット**: 様々な資産を含むサンプルポートフォリオ（基本実装済み）

## 10. 継続的インテグレーション

現状: 基本的なGitHub Actionsワークフローが設定されている可能性があるが、拡張が必要

### 改善すべき点

- テストの並列実行による高速化
- 性能テストの自動実行設定（最低限のベンチマーク）
- カバレッジレポートの自動化と可視化
- ブランチ保護ルールとの統合（テスト失敗時にマージを防止）

## 11. テストレポート

現状: 基本的なテスト結果出力のみ

### 改善すべき点

- テストカバレッジの視覚的ダッシュボード
- 時系列でのテスト結果と性能傾向の追跡
- テスト失敗の自動分析とカテゴリ化

## テスト実装ロードマップ（修正版）

1. **単体テストのカバレッジ向上** (2ヶ月)
   - `retry.js`、`dataFetchWithFallback.js`の完全なテスト実装
   - `scrapingBlacklist.js`、`budgetCheck.js`のテスト追加
   - 目標: 単体テストカバレッジを45%に向上

2. **統合テストの拡張** (3-4ヶ月)
   - マルチソースフォールバックの完全テスト
   - レート制限とバジェット制限のテスト実装
   - キャッシュシステムの完全な統合テスト
   - 目標: 統合テストカバレッジを40%に向上

3. **E2Eテストの強化** (4-5ヶ月)
   - 複雑なデータシナリオのテスト追加
   - エラー処理シナリオの網羅的テスト
   - 目標: すべての主要ユーザーパスをカバー

4. **性能・セキュリティテストの導入** (5-7ヶ月)
   - レスポンス時間とスループットのベンチマーク構築
   - 基本的なセキュリティテストスイートの実装
   - 目標: 基準性能測定と主要セキュリティリスクの評価

5. **テストインフラの改善** (6-8ヶ月)
   - テストレポート自動化
   - CI/CDパイプラインの最適化
   - テストデータ管理システムの強化

6. **継続的な改善** (継続的)
   - テストカバレッジの定期的なレビュー
   - 新機能の追加に合わせたテストケースの拡張
   - ボトルネックの特定と性能最適化

## 現状の成果と課題

### 成果
- 基本的な機能テストが完了し、API機能の基本的な検証が可能
- 認証フローと基本的なエラー処理の検証が十分に実装
- ユーティリティ関数の多くがテスト済み

### 課題
- 全体的なカバレッジが目標の半分以下（30.7%）
- 性能テストとセキュリティテストの未実装
- フォールバックメカニズムとエラー処理の高度なシナリオのテスト不足
- 管理者機能とモニタリング機能のテスト未実装

このテスト計画は、現在の進捗状況を反映し、より現実的なタイムラインと目標を設定しています。段階的なアプローチでテストカバレッジと品質を向上させることを目指します。
